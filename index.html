<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Treeniseuranta</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    label, input, select, button { margin: 5px 0; display: block; }
    canvas { max-width: 100%; height: auto; }
    .hidden { display: none; }
    .hint { color: #aaa; font-size: 0.9em; }
    #timer { font-weight: bold; font-size: 1.2em; margin: 10px 0; }
    .set-row { margin-bottom: 10px; border-left: 2px solid #ddd; padding-left: 10px; }
    .add-set-btn { margin-top: 5px; }
  </style>
</head>
<body>
    <div id="main-menu">
      <h1>Teit hyvin, kun tulit treenille ystäväsi.</h1>
      <label for="user">Valitse käyttäjä:</label>
      <select id="user">
        <option value="">-- Valitse --</option>
        <option value="Matias">Matias</option>
        <option value="Eeva">Eeva</option>
      </select>
      <button onclick="goToProgramSelection()">Aloita treeni</button>
      <button onclick="showSection('history-view')">Katso treenihistoriaa</button>
    </div>
  
  <div id="program-selection" class="hidden">
    <label for="program">Valitse treeni:</label>
    <select id="program" onchange="showExercises()">
      <option value="">-- Valitse --</option>
    </select>
  </div>
  
  <div id="history-view" class="hidden">
    <h2>Treenihistoria</h2>
    <div id="history-list"></div>
    <button onclick="showSection('main-menu')">Takaisin alkuun</button>
  </div>

  <div id="timer" class="hidden">Treenin kesto: <span id="elapsed">00:00:00</span></div>

  <div id="exercise-section" class="hidden">
    <h2>Liikkeet</h2>
    <div id="exercise-entries"></div>
    <button onclick="saveWorkout()">Tallenna treeni</button>
    <button onclick="stopWorkout()">Lopeta treeni</button>
  </div>

  <div id="final-message" class="hidden">
    <h2>Hienoa työtä.</h2>
    <p>"Se, joka liikuttaa vuorta, aloittaa kantamalla pois pieniä kiviä." – Kungfutse</p>
  </div>

  <script>
    let startTime = null;
    let timerInterval = null;

    const programs = {
      Matias: {
        "Jalkapäivä": ["kyykky", "jalkaprässi", "takareidet"],
        "Vetopäivä": ["mave", "leuanveto", "hauiskääntö"],
        "Työntöpäivä": ["penkki", "pystypunnerrus", "ojentajat"],
        "Käsipäivä": ["hauiskääntö", "ojentajat", "vipunostot"]
      },
      Eeva: {
        "Jalkapäivä": ["kyykky", "askelkyykky", "pohkeet"],
        "Vetopäivä": ["ylätalja", "kulmasoutu", "hauiskääntö"],
        "Työntöpäivä": ["penkki", "rintaprässi", "ojentajat"],
        "Käsipäivä": ["hauiskääntö", "ojentajat", "sivuviparit"]
      }
    };

    function loadPrograms() {
      const user = document.getElementById('user').value;
      const programSelect = document.getElementById('program');
      const section = document.getElementById('program-section');
      programSelect.innerHTML = '<option value="">-- Valitse --</option>';
      if (programs[user]) {
        for (const key in programs[user]) {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = key;
          programSelect.appendChild(option);
        }
        section.classList.remove('hidden');
      }
    }

    function showExercises() {
      const user = document.getElementById('user').value;
      const program = document.getElementById('program').value;
      const exercises = programs[user][program];
      const container = document.getElementById('exercise-entries');
      container.innerHTML = '';

      const data = JSON.parse(localStorage.getItem('treenidata') || '{}');
      const lastDate = Object.keys(data).sort().reverse().find(d => data[d]);

      exercises.forEach(ex => {
        const div = document.createElement('div');
        div.innerHTML = `<h4>${ex}</h4>
          <div id="${ex}-sets">
            ${generateSetInputs(ex, 3)}
          </div>
          <button class="add-set-btn" onclick="addSet('${ex}')">Lisää sarja</button>
          <div class="hint">Viimeksi: ${getLastEntry(data, lastDate, ex)}</div>`;
        container.appendChild(div);
      });

      document.getElementById('exercise-section').classList.remove('hidden');
      startTimer();
    }

    function generateSetInputs(ex, count) {
      let html = '';
      for (let i = 0; i < count; i++) {
        html += `
          <div class="set-row">
            <strong>Sarja ${i + 1}</strong>
            <label>Paino (kg): <input type="number" name="${ex}-weight"></label>
            <label>Toistot: <input type="number" name="${ex}-reps"></label>
            <button type="button" onclick="removeSet(this)">Poista</button>
          </div>`;
      }
      return html;
    }

    function showSection(id) {
      const sections = ['main-menu', 'program-selection', 'exercise-section', 'history-view', 'final-message'];
      sections.forEach(sec => document.getElementById(sec)?.classList.add('hidden'));
      document.getElementById(id)?.classList.remove('hidden');
    }
    
    function goToProgramSelection() {
      const user = document.getElementById('user').value;
      if (!user) {
        alert("Valitse käyttäjä ensin!");
        return;
      }
    
      // Täytetään ohjelmavalinta
      const programSelect = document.getElementById('program');
      programSelect.innerHTML = '<option value="">-- Valitse --</option>';
      if (programs[user]) {
        for (const key in programs[user]) {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = key;
          programSelect.appendChild(option);
        }
      }
    
      // Näytä seuraava näkymä
      showSection('program-selection');
    }



    function loadHistory() {
      const data = JSON.parse(localStorage.getItem('treenidata') || '{}');
      const container = document.getElementById('history-list');
      container.innerHTML = '';
    
      const dates = Object.keys(data).sort().reverse();
      dates.forEach(date => {
        const entry = data[date];
        const div = document.createElement('div');
        div.innerHTML = `<strong>${date}</strong><ul>` +
          Object.keys(entry).filter(k => k !== '_meta').map(ex =>
            `<li>${ex}: ${entry[ex].map(s => `${s.weight}kg × ${s.reps}`).join(', ')}</li>`
          ).join('') + `</ul>`;
        container.appendChild(div);
      });
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      loadHistory();
    });

    
    function addSet(ex) {
      const container = document.getElementById(`${ex}-sets`);
      const setCount = container.querySelectorAll('.set-row').length;
      const div = document.createElement('div');
      div.className = 'set-row';
      div.innerHTML = `
        <strong>Sarja ${setCount + 1}</strong>
        <label>Paino (kg): <input type="number" name="${ex}-weight"></label>
        <label>Toistot: <input type="number" name="${ex}-reps"></label>
        <button type="button" onclick="removeSet(this)">Poista</button>
      `;
      container.appendChild(div);
    }

    function removeSet(button) {
      const row = button.parentElement;
      row.remove();
    }
    

    function getLastEntry(data, date, exercise) {
      if (!date || !data[date][exercise]) return '–';
      const sets = data[date][exercise].map(e => `${e.weight}kg × ${e.reps}`).join(', ');
      return `${date}: ${sets}`;
    }

    function saveWorkout() {
      const date = new Date().toISOString().split('T')[0];
      const user = document.getElementById('user').value;
      const program = document.getElementById('program').value;
      const exercises = programs[user][program];
      const data = JSON.parse(localStorage.getItem('treenidata') || '{}');
      if (!data[date]) data[date] = {};

      exercises.forEach(ex => {
        const weightInputs = document.getElementsByName(`${ex}-weight`);
        const repInputs = document.getElementsByName(`${ex}-reps`);
        if (!data[date][ex]) data[date][ex] = [];
        for (let i = 0; i < weightInputs.length; i++) {
          const weight = parseFloat(weightInputs[i].value);
          const reps = parseInt(repInputs[i].value);
          if (!isNaN(weight) && !isNaN(reps)) {
            data[date][ex].push({ weight, reps, rir: null });
          }
        }
      });

      localStorage.setItem('treenidata', JSON.stringify(data));
      alert('Treenit tallennettu!');
    }

    function startTimer() {
      const timer = document.getElementById('timer');
      timer.classList.remove('hidden');
      const display = document.getElementById('elapsed');
      startTime = Date.now();
      timerInterval = setInterval(() => {
        const elapsed = Date.now() - startTime;
        const hours = String(Math.floor(elapsed / 3600000)).padStart(2, '0');
        const minutes = String(Math.floor((elapsed % 3600000) / 60000)).padStart(2, '0');
        const seconds = String(Math.floor((elapsed % 60000) / 1000)).padStart(2, '0');
        display.textContent = `${hours}:${minutes}:${seconds}`;
      }, 1000);
    }

    function stopWorkout() {
      clearInterval(timerInterval);
      document.getElementById('timer').classList.add('hidden');
      document.getElementById('exercise-section').classList.add('hidden');
      document.getElementById('final-message').classList.remove('hidden');
    }
  </script>
</body>
</html>
